<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Malla Interactiva QyF UNACH</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@700&display=swap');

    /* Base/Default (Light) Theme */
    :root {
      --bg: #f4f7f9; /* Lighter, cleaner background */
      --text: #333;
      --card: #fff;
      --accent: #1565C0; /* Strong Blue */
      --accent2: #42A5F5; /* Lighter Blue */
      --green: #10B981; /* Teal Green */
      --yellow: #FACC15; /* Amber Yellow */
      --lila: #9C27B0; /* Deep Purple */
      --red: #EF5350; /* Red */
      --shadow: rgba(0,0,0,0.08);
      --ramo-bg: #eceff1; /* Light Gray Blue */
      --ramo-aprobado-bg: #c8e6c9; /* Light Green */
      --ramo-desbloqueado-bg: #fff8e1; /* Very Light Yellow */
      --creditos-bg: rgba(255, 255, 255, 0.8);
      --success-modal-bg: #e8f5e9;
      --success-modal-text: #1b5e20;
    }

    /* Dark Theme */
    body.dark {
      --bg: #1a1a1a;
      --text: #eee;
      --card: #2c2c2c;
      --accent: #4a90e2;
      --accent2: #72aeff;
      --green: #4CAF50;
      --yellow: #FFEB3B;
      --lila: #AB47BC;
      --red: #FF5252;
      --shadow: rgba(0,0,0,0.4);
      --ramo-bg: #3c3c3c;
      --ramo-aprobado-bg: #2e4b30;
      --ramo-desbloqueado-bg: #5f4b00;
      --creditos-bg: rgba(44, 44, 44, 0.8);
      --success-modal-bg: #388e3c;
      --success-modal-text: #e8f5e9;
    }

    /* Pastel Theme */
    body.pastel {
      --bg: #f8e1fa;
      --text: #5d3f6a;
      --card: #fefefe;
      --accent: #d8a7e0;
      --accent2: #e9c3f0;
      --green: #a7d8b0;
      --yellow: #f0e68c;
      --lila: #c3a7e0;
      --red: #f0a7a7;
      --shadow: rgba(0,0,0,0.1);
      --ramo-bg: #f3e9f5;
      --ramo-aprobado-bg: #e0f0e0;
      --ramo-desbloqueado-bg: #f5f5e0;
      --creditos-bg: rgba(254, 254, 254, 0.8);
      --success-modal-bg: #a7d8b0;
      --success-modal-text: #5d3f6a;
    }

    /* Celeste Theme */
    body.celeste {
      --bg: #e0f7fa;
      --text: #004d40;
      --card: #ffffff;
      --accent: #00838f;
      --accent2: #00acc1;
      --green: #4db6ac;
      --yellow: #ffb74d;
      --lila: #7986cb;
      --red: #ef5350;
      --shadow: rgba(0,0,0,0.1);
      --ramo-bg: #e0f2f7;
      --ramo-aprobado-bg: #b2ebf2;
      --ramo-desbloqueado-bg: #ffe0b2;
      --creditos-bg: rgba(255, 255, 255, 0.8);
      --success-modal-bg: #4db6ac;
      --success-modal-text: #004d40;
    }

    /* Rosado Theme */
    body.rosado {
      --bg: #ffebee;
      --text: #880e4f;
      --card: #ffffff;
      --accent: #c2185b;
      --accent2: #e91e63;
      --green: #a5d6a7;
      --yellow: #ffcc80;
      --lila: #ce93d8;
      --red: #ef9a9a;
      --shadow: rgba(0,0,0,0.1);
      --ramo-bg: #fce4ec;
      --ramo-aprobado-bg: #f8bbd0;
      --ramo-desbloqueado-bg: #fff9c4;
      --creditos-bg: rgba(255, 255, 255, 0.8);
      --success-modal-bg: #e91e63;
      --success-modal-text: #ffffff;
    }

    /* Verde Theme */
    body.verde {
      --bg: #e8f5e9;
      --text: #1b5e20;
      --card: #ffffff;
      --accent: #388e3c;
      --accent2: #4caf50;
      --green: #81c784;
      --yellow: #fff176;
      --lila: #9ccc65;
      --red: #ef5350;
      --shadow: rgba(0,0,0,0.1);
      --ramo-bg: #e0f2f1;
      --ramo-aprobado-bg: #c8e6c9;
      --ramo-desbloqueado-bg: #fffde7;
      --creditos-bg: rgba(255, 255, 255, 0.8);
      --success-modal-bg: #4caf50;
      --success-modal-text: #ffffff;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: 'Inter', sans-serif;
      background: var(--bg); color: var(--text);
      transition: background .3s, color .3s;
      overflow-x: hidden; /* Prevent horizontal scrolling on small screens */
    }
    
    /* --- HEADER REDESIGN --- */
    #main-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 30px;
      background: var(--card);
      color: var(--text);
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 8px var(--shadow);
      border-bottom: 4px solid var(--accent);
      flex-wrap: wrap;
      gap: 20px;
    }
    #header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    #header-left img {
      height: 60px; /* Logo más grande */
      width: auto;
    }
    #malla-link a {
      color: var(--accent);
      font-weight: 600;
      text-decoration: none;
      padding: 8px 12px;
      background: var(--ramo-bg);
      border-radius: 8px;
      transition: background .2s, color .2s;
      font-size: 0.9em;
    }
    #malla-link a:hover { 
      background: var(--accent);
      color: #fff;
    }
    
    #header-title {
        font-family: 'Playfair Display', serif;
        font-size: 2.2em;
        font-weight: 700;
        text-align: center;
        flex-grow: 1;
        color: var(--accent);
        line-height: 1.2;
    }
    #unach-qf-link {
        color: inherit;
        text-decoration: none;
    }
    #university-name {
        display: block;
        font-size: 0.5em;
        font-weight: 600;
        color: var(--text);
        margin-top: 4px;
        font-family: 'Inter', sans-serif;
    }

    #header-right {
      display: flex; align-items: center; gap: 12px;
      font-size: .9em;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    #clock {
      padding: 8px 12px;
      background: var(--ramo-bg);
      border-radius: 8px;
      font-family: monospace;
      min-width: 120px;
      text-align: center;
      font-weight: 600;
    }
    #theme-selector {
        padding: 8px 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: .9em;
        background: var(--card);
        color: var(--text);
    }

    /* --- Login/User Panel Styles --- */
    #user-panel { position: relative; }
    .user-btn {
        background: var(--accent);
        color: #fff;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        border: none;
        font-family: 'Inter', sans-serif;
        font-weight: 600;
        transition: background .2s;
    }
    .user-btn:hover { background: var(--accent2); }
    #login-dropdown {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        margin-top: 8px;
        background: var(--card);
        color: var(--text);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 5px 15px var(--shadow);
        width: 280px;
        z-index: 1100;
        border: 1px solid var(--ramo-bg);
    }
    #login-dropdown.show { display: block; }
    #login-dropdown h4 {
        margin-top: 0;
        margin-bottom: 15px;
        text-align: center;
        color: var(--accent);
    }
    #login-dropdown input {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background: var(--bg);
        color: var(--text);
    }
    #login-dropdown button {
        width: 100%;
        padding: 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.2s;
    }
    #login-dropdown .btn-login {
        background: var(--accent);
        color: #fff;
    }
     #login-dropdown .btn-login:hover { background: var(--accent2); }
    #login-dropdown .btn-google {
        background: #fff;
        color: #757575;
        margin-top: 10px;
        border: 1px solid #ccc;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }
    #login-dropdown .btn-google:hover { background: #f5f5f5; }
    #login-dropdown .btn-google img {
        width: 18px;
        height: 18px;
    }
    #login-dropdown .form-footer {
        font-size: 0.85em;
        text-align: center;
        margin-top: 15px;
    }
    #login-dropdown .form-footer a {
        color: var(--accent);
        cursor: pointer;
        text-decoration: none;
    }
     #login-dropdown .form-footer a:hover { text-decoration: underline; }
    #user-info { display: none; align-items: center; gap: 10px; }
    #user-info #user-name { font-weight: 600; }
    #user-info #logout-btn {
        background: var(--red);
        color: white;
        padding: 8px 12px;
    }


    /* BARRA SECUNDARIA */
    #topbar {
      display: flex; align-items: center; justify-content: center; /* Centered items */
      padding: 8px 20px; background: var(--accent);
      color: #fff; position: sticky; top: 105px; /* Adjust for new header height */
      z-index: 900;
      box-shadow: 0 2px 4px var(--shadow);
      font-size: .9em;
      flex-wrap: wrap; /* Allow items to wrap on smaller screens */
      gap: 10px; /* Space between topbar items */
    }

    /* Combined Info Section */
    #combined-info {
        background: rgba(255,255,255,0.1);
        padding: 5px 10px;
        border-radius: 8px;
        transition: background 0.2s ease;
        white-space: nowrap; /* Keep summary text on one line */
    }
    #combined-info summary {
        cursor: pointer;
        font-weight: 600;
        outline: none; /* Quitar el contorno al hacer clic */
        display: flex; /* Use flex to align text and custom marker */
        align-items: center;
        justify-content: space-between; /* Push marker to the right */
    }
    #combined-info summary::-webkit-details-marker {
        display: none; /* Ocultar el marcador predeterminado */
    }
    #combined-info summary:after { /* Custom marker for details summary */
        content: '\25B6'; /* Right-pointing triangle */
        font-size: 0.8em;
        margin-left: 8px;
        transition: transform 0.2s;
    }
    #combined-info[open] summary:after {
        content: '\25BC'; /* Down-pointing triangle when open */
    }
    #combined-info > div { /* Target the div directly inside details for content */
        margin-top: 5px; /* Espacio para el contenido desplegado */
        display: flex;
        flex-direction: column; /* Stack details content vertically */
        gap: 5px; /* Smaller gap for stacked items */
        font-size: 0.85em; /* Slightly smaller font for details content */
    }
    #combined-info ul {
      list-style: none; margin: 0; padding-left: 0; font-size: .9em;
    }
    #combined-info ul li {
        margin-bottom: 4px;
    }
    #combined-info ul li:last-child {
        margin-bottom: 0;
    }


    #topbar-controls {
      display: flex; align-items: center; gap: 12px;
      flex-wrap: wrap; /* Allow controls to wrap */
      justify-content: center; /* Center controls */
      flex-grow: 1; /* Allow controls to take available space */
    }
    #topbar-controls input[type="text"],
    #topbar-controls select {
      padding: 6px 8px; border: none; border-radius: 4px;
      font-size: .9em;
      background: var(--card); /* Color de fondo para inputs/selects */
      color: var(--text); /* Color de texto para inputs/selects */
    }
    #topbar-controls button {
      background: var(--accent2); border: none; color: #fff;
      padding: 6px 10px; border-radius: 4px; cursor: pointer;
      transition: background .2s; font-size: .9em;
    }
    #topbar-controls button:hover { background: #2e7dff; }
    #contador { font-weight: 600; margin-left: 8px; }

    /* Nuevo estilo para la sección de créditos en el topbar (solo total) */
    #creditos-info {
        margin-left: 15px;
        font-size: 0.9em;
        display: flex;
        align-items: center;
        gap: 8px;
        background: var(--creditos-bg); /* Fondo similar al card, pero distinto */
        padding: 8px 12px;
        border-radius: 8px; /* Bordes redondeados */
        box-shadow: 0 1px 3px var(--shadow); /* Sombra ligera */
        color: var(--text); /* Asegura que el texto sea visible */
    }
    #creditos-info .dot { /* Hide dots from topbar credits */
        display: none;
    }
    #creditos-info span {
        font-weight: 600;
    }
    #creditos-total {
        font-size: 1.1em;
    }

    /* Estilo para el nuevo botón de información del tr._nico */
    .btn-info {
        background: var(--accent2);
        border: none;
        color: #fff;
        padding: 6px 10px;
        border-radius: 4px;
        cursor: pointer;
        transition: background .2s;
        font-size: .9em;
        font-weight: 700;
        width: 30px; /* Para que sea un botón cuadrado */
        height: 30px;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .btn-info:hover {
        background: #2e7dff;
    }


    /* LAYOUT PRINCIPAL */
    #content-wrapper {
      display: flex; gap: 20px; padding: 20px;
      align-items: flex-start; /* Alinea los elementos al inicio */
      flex-wrap: wrap; /* Allow content to wrap on smaller screens */
    }
    /* LEYENDA ÁREAS */
    #legend {
      background: var(--card); padding: 12px; border-radius: 8px;
      box-shadow: 0 2px 6px var(--shadow); min-width: 180px;
      color: var(--text); /* Asegura que el texto sea visible en modo oscuro */
      margin-bottom: 20px; /* Espacio entre la leyenda y los nuevos widgets */
    }
    #legend table { width: 100%; border-collapse: collapse; font-size: .9em; }
    #legend th { padding-bottom: 8px; text-align: left; }
    #legend td { padding: 4px 0; display: flex; align-items: center; justify-content: space-between; } /* Added flex for alignment */
    #legend td span:last-child { margin-left: auto; font-weight: 600; } /* Align credit count to right */

    .dot {
      display: inline-block; width: 10px; height: 10px;
      border-radius: 50%; margin-right: 6px; vertical-align: middle;
    }
    .area-espiritual { background: green; }
    .area-general    { background: #00bcd4; }
    .area-profesional{ background: var(--yellow); }
    .area-especialidad { background: var(--lila); }
    .area-practica   { background: red; }

    /* Nuevo estilo para la barra lateral de widgets */
    #left-sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px; /* Espacio entre la leyenda y el panel de widgets */
      min-width: 200px; /* Ancho mínimo para la barra lateral */
      max-width: 250px; /* Ancho máximo */
      flex-shrink: 0; /* Evita que la barra lateral se encoja */
      width: 100%; /* Default to full width on small screens */
    }

    #widgets-panel {
      background: var(--card);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 15px; /* Espacio entre los widgets */
    }

    #widgets-panel h3 {
      margin-top: 0;
      margin-bottom: 10px;
      color: var(--accent);
      text-align: center;
      font-size: 1.2em;
    }

    .widget-card {
      padding: 10px;
      border-radius: 6px;
      background: var(--ramo-bg); /* Un color de fondo suave para los widgets */
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      text-align: center;
    }

    .widget-card h4 {
      margin-top: 0;
      margin-bottom: 8px;
      color: var(--accent2);
      font-size: 1em;
    }

    .widget-card a {
      display: inline-block;
      background: var(--accent);
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      text-decoration: none;
      font-weight: 600;
      transition: background 0.2s ease;
    }

    .widget-card a:hover {
      background: #0d47a1;
    }

    /* Calendar Widget Specific Styles */
    #calendar-widget {
        text-align: left;
    }
    #calendar-widget h4 {
        text-align: center;
    }
    #calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    #calendar-header button {
        background: var(--accent);
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
    }
    #calendar-header button:hover {
        background: #0d47a1;
    }
    #calendar-header h5 {
        margin: 0;
        font-size: 1.1em;
        color: var(--accent);
    }
    #calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        font-size: 0.85em;
    }
    .day-name {
        background: var(--accent2);
        color: white;
        padding: 5px 0;
        text-align: center;
        font-weight: 600;
    }
    .calendar-day {
        background: var(--ramo-bg);
        padding: 5px;
        text-align: center;
        min-height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 3px;
    }
    .calendar-day.empty {
        background: #eee; /* Lighter background for empty days */
        color: #ccc;
    }
    body.dark .calendar-day.empty {
        background: #444;
        color: #777;
    }
    .calendar-day.current-day {
        background: var(--green);
        color: white;
        font-weight: 700;
    }


    /* MALLA Y ZOOM */
    #malla-container {
      overflow: auto; transform-origin: top center;
      flex-grow: 1; /* Permite que la malla ocupe el espacio restante */
    }
    #malla {
      display: flex; flex-direction: column; gap: 24px;
      width: max-content; margin: auto;
    }
    .year {
      display: grid;
      grid-template-columns: repeat(2, minmax(240px,1fr));
      gap: 20px;
      background: var(--card);
      border-radius: 8px;
      box-shadow: 0 2px 6px var(--shadow);
      position: relative;
      transition: border 0.3s, box-shadow 0.3s, background 0.3s;
    }
    .year[data-year-complete] {
      border: 2px solid gold;
      box-shadow: 0 0 8px rgba(255,215,0,0.8);
    }
    .year-label {
      grid-column: 1 / -1;
      background: linear-gradient(90deg,var(--accent2),var(--accent)); /* Gradient background */
      color: #fff;
      text-align: center;
      padding: 10px;
      font-weight: 600;
      font-size: 1.1em;
      display: flex; /* Usar flexbox para alinear el título y el botón de sello */
      justify-content: space-between; /* Espacio entre el título y el botón */
      align-items: center; /* Centrar verticalmente */
      padding-left: 20px; /* Ajuste de padding para el texto */
      padding-right: 20px; /* Ajuste de padding para el botón */
    }
    .horas-sellos-btn {
        background: rgba(255,255,255,0.2);
        color: #fff;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.8em;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease;
        white-space: nowrap; /* Evita que el texto se rompa */
    }
    .horas-sellos-btn:hover {
        background: rgba(255,255,255,0.4);
    }
    .semestre {
      padding: 12px;
      display: flex;
      flex-direction: column;
    }
    .semestre::before {
      content: attr(data-sem)"° Semestre";
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 10px;
    }
    .progress {
      width: 100%; height: 8px;
      background: #ddd; /* Fondo de la barra de progreso */
      border-radius: 4px;
      overflow: hidden; margin-bottom: 10px;
    }
    body.dark .progress {
        background: #555; /* Fondo de la barra de progreso en modo oscuro */
    }
    .progress-fill {
      width: 0; height: 100%;
      background: var(--green);
      transition: width .3s;
    }
    .ramo {
      background: var(--ramo-bg);
      margin: 6px 0;
      padding: 8px 10px;
      border-radius: 4px;
      cursor: pointer;
      transition: transform .2s, box-shadow .2s, background .2s, color .2s;
      border-left: 4px solid transparent;
      font-size: .95em;
      display: flex; align-items: center;
      color: var(--text); /* Asegura que el texto sea visible */
    }
    .ramo .dot { margin-right: 8px; }
    .ramo:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    /* ANIMACIONES DE RAMOS */
    .aprobado {
      background: var(--ramo-aprobado-bg) !important;
      border-left-color: var(--green) !important;
      animation: sparkle-green 0.6s ease-out forwards; /* Animación al aprobar */
    }
    @keyframes sparkle-green {
        0% { transform: scale(1); box-shadow: 0 0 0 var(--green); opacity: 1; }
        50% { transform: scale(1.03); box-shadow: 0 0 15px var(--green), 0 0 30px var(--green); opacity: 0.8; }
        100% { transform: scale(1); box-shadow: 0 0 0 var(--green); opacity: 1; }
    }

    .desbloqueado {
      background: var(--ramo-desbloqueado-bg) !important;
      border-left-color: var(--yellow) !important;
      animation: pulse-yellow 1.5s infinite alternate ease-in-out; /* Animación parpadeante */
    }
    @keyframes pulse-yellow {
        0% { box-shadow: 0 0 0 rgba(250, 204, 21, 0.4); }
        100% { box-shadow: 0 0 15px rgba(250, 204, 21, 0.8); }
    }

    .error {
      animation: shake .3s;
      background: var(--red) !important;
      color: #fff !important;
    }
    @keyframes shake {
      0%,100% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      75% { transform: translateX(4px); }
    }
    .highlight {
      border: 2px solid gold !important;
      animation: pulse 1s infinite alternate;
    }
    @keyframes pulse {
      from { box-shadow: 0 0 0 rgba(255,215,0,0.5); }
      to   { box-shadow: 0 0 10px rgba(255,215,0,1); }
    }
    .empty { visibility: hidden; }
    /* INFO Y CALCULADORAS */
    .calc-box {
      background: var(--card);
      padding: 8px 12px;
      margin: 8px 0;
      border-radius: 4px;
      box-shadow: 0 1px 3px var(--shadow);
    }
    .calc-box a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
    }

    /* Estilos para los Modales */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
    }

    .modal-backdrop.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background-color: var(--card);
      color: var(--text);
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 5px 15px var(--shadow);
      width: 90%;
      max-width: 500px;
      transform: translateY(-20px);
      transition: transform 0.3s ease;
      position: relative;
    }

    .modal-backdrop.show .modal-content {
      transform: translateY(0);
    }

    .modal-close-button {
      position: absolute;
      top: 10px;
      right: 15px;
      background: none;
      border: none;
      font-size: 1.5em;
      cursor: pointer;
      color: var(--text);
    }

    .modal-title {
      font-size: 1.5em;
      font-weight: 700;
      margin-bottom: 15px;
      color: var(--accent);
    }

    .modal-info p {
      margin-bottom: 8px;
      font-size: 0.95em;
    }

    .modal-info p strong {
      color: var(--accent2);
    }

    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    .modal-buttons button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s;
    }

    .modal-buttons .btn-aprobado {
      background-color: var(--green);
      color: white;
    }

    .modal-buttons .btn-aprobado:hover {
      background-color: #0b9e6f;
    }

    .modal-buttons .btn-desmarcar {
      background-color: var(--red);
      color: white;
    }

    .modal-buttons .btn-desmarcar:hover {
      background-color: #d84315;
    }

    .modal-buttons .btn-close {
        background-color: #ccc;
        color: var(--text);
    }

    .modal-buttons .btn-close:hover {
        background-color: #bbb;
    }

    /* Estilos para el modal de confirmación personalizado */
    .custom-confirm-modal .modal-content {
        max-width: 400px;
        text-align: center;
    }
    .custom-confirm-modal .modal-title {
        color: var(--red);
    }
    .custom-confirm-modal .modal-buttons {
        justify-content: center;
    }

    /* Estilos para el modal de mensaje personalizado (tr._nico) */
    .custom-alert-modal .modal-content {
        max-width: 400px;
        text-align: center;
    }
    .custom-alert-modal .modal-title {
        color: var(--accent); /* Color principal para el título del mensaje */
    }
    .custom-alert-modal .modal-buttons {
        justify-content: center;
    }

    /* Nuevo Modal de Felicidades por Semestre */
    #semester-complete-modal .modal-content {
        background-color: var(--success-modal-bg);
        color: var(--success-modal-text);
        border: 3px solid var(--green);
        animation: bounceIn 0.6s ease-out;
        text-align: center;
        max-width: 550px;
    }
    #semester-complete-modal .modal-title {
        color: var(--success-modal-text);
        font-size: 2em;
        margin-bottom: 10px;
    }
    #semester-complete-modal p {
        font-size: 1.2em;
        margin-bottom: 20px;
    }
    #semester-complete-modal .modal-buttons {
        justify-content: center;
    }
    #semester-complete-modal .modal-buttons .btn-close {
        background-color: var(--green);
        color: white;
    }
    #semester-complete-modal .modal-buttons .btn-close:hover {
        background-color: #0b9e6f;
    }

    @keyframes bounceIn {
        0% { transform: scale(0.3); opacity: 0; }
        50% { transform: scale(1.05); opacity: 1; }
        70% { transform: scale(0.9); }
        100% { transform: scale(1); }
    }

    /* --- Responsive Design --- */
    @media (max-width: 1024px) {
        #main-header, #topbar {
            padding: 10px;
            flex-direction: column;
            align-items: stretch;
            gap: 8px;
        }
        #header-left {
            justify-content: center;
        }
        #header-right, #topbar-controls {
            width: 100%;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        #header-title {
            font-size: 1.3em;
            order: -1; /* Move title to the top on mobile */
            width: 100%;
        }
        #university-name {
            font-size: 0.7em;
        }
        #clock {
            min-width: unset;
            width: auto;
        }
        #creditos-info {
            margin-left: 0;
            width: 100%;
            justify-content: center;
        }
        #content-wrapper {
            flex-direction: column;
            padding: 15px;
            gap: 15px;
        }
        #left-sidebar {
            max-width: 100%;
            min-width: unset;
        }
        #malla-container {
            width: 100%;
            overflow-x: auto; /* Allow horizontal scroll for the malla if it's too wide */
        }
        #malla {
            width: fit-content; /* Allow malla to take its natural width */
            margin: 0 auto;
        }
        .year {
            grid-template-columns: 1fr; /* Stack semestres vertically */
            gap: 15px;
        }
        .year-label {
            padding: 10px 15px;
            flex-direction: column;
            gap: 5px;
        }
        .horas-sellos-btn {
            font-size: 0.75em;
            padding: 4px 8px;
        }
        .ramo {
            font-size: 0.9em;
            padding: 6px 8px;
        }
        #combined-info summary {
            width: 100%; /* Make summary take full width */
        }
        #combined-info > div {
            width: 100%;
        }
    }

    @media (max-width: 600px) {
        #main-header {
            padding: 8px 10px;
        }
        #header-left img {
            height: 40px;
        }
        #header-title {
            font-size: 1.1em;
        }
        #university-name {
            font-size: 0.6em;
        }
        #topbar {
            padding: 8px 10px;
            font-size: 0.8em;
        }
        #topbar-controls button,
        #topbar-controls input,
        #topbar-controls select {
            font-size: 0.8em;
            padding: 5px 8px;
        }
        #creditos-info {
            font-size: 0.8em;
            padding: 6px 10px;
        }
        #legend {
            font-size: 0.8em;
            padding: 10px;
        }
        .widget-card h4 {
            font-size: 0.9em;
        }
        .widget-card a {
            padding: 6px 10px;
            font-size: 0.85em;
        }
        /* Further adjust malla layout if needed for very small screens */
        .ramo {
            font-size: 0.85em;
        }
        #login-dropdown {
            width: 90vw;
        }
    }

  </style>
</head>
<body>
  <!-- HEADER PRINCIPAL -->
  <header id="main-header">
    <div id="header-left">
      <img src="logo-unach.png" alt="Logo UNACH" onerror="this.onerror=null;this.src='https://placehold.co/150x40/007bff/ffffff?text=UNACH';">
      <div id="malla-link">
        <a href="https://www.unach.cl/wp-content/uploads/2022/11/Qui%CC%81micayFarmacia-2023.pdf" target="_blank">
          Malla QyF
        </a>
      </div>
    </div>
    <div id="header-title">
      <!-- Título principal ahora es un enlace -->
      <a href="https://www.unach.cl/quimica-y-farmacia/" target="_blank" id="unach-qf-link">
        Química y Farmacia
      </a><br>
      <!-- Nombre de la universidad con tamaño de fuente más grande -->
      <span id="university-name">Universidad Adventista de Chile</span>
    </div>
    <div id="header-right">
      Zoom <input id="zoom" type="range" min="50" max="150" value="100"/>%
      <label for="theme-selector">Tema:</label>
      <select id="theme-selector">
        <option value="light">Claro</option>
        <option value="dark">Oscuro</option>
        <option value="pastel">Pastel</option>
        <option value="celeste">Celeste</option>
        <option value="rosado">Rosado</option>
        <option value="verde">Verde</option>
      </select>
      <div id="clock"></div>
      <!-- User Panel -->
      <div id="user-panel">
        <button id="login-btn" class="user-btn">Iniciar Sesión</button>
        <div id="login-dropdown">
            <h4>Iniciar Sesión</h4>
            <input type="email" id="login-email" placeholder="Correo electrónico" required>
            <input type="password" id="login-password" placeholder="Contraseña" required>
            <button id="login-submit-btn" class="btn-login">Ingresar</button>
            <button id="google-login-btn" class="btn-google">
                <img src="logo-google.png" alt="Google logo">
                <span>Ingresar con Google</span>
            </button>
            <div class="form-footer">
                <p>¿No tienes cuenta? <a id="create-account-link">Crea una aquí</a></p>
            </div>
        </div>
        <div id="user-info">
            <span id="user-name"></span>
            <button id="logout-btn" class="user-btn">Salir</button>
        </div>
      </div>
    </div>
  </header>

  <!-- BARRA SECUNDARIA -->
  <div id="topbar">
    <div id="topbar-controls">
      <!-- Botón de información del tr._nico -->
      <button id="tr-nico-info-btn" class="btn-info">?</button>
      <span>Progreso: <span id="contador">0%</span></span>
      <div id="creditos-info">
        Créditos Totales: <span id="creditos-total">0</span>/330
      </div>
      <input id="buscador" type="text" placeholder="Buscar asignatura…"/>
      <select id="area-filter">
        <option value="">Todas Áreas</option>
        <option value="espiritual">Espiritual</option>
        <option value="general">General</option>
        <option value="profesional">Profesional</option>
        <option value="especialidad">Especialidad</option>
        <option value="practica">Práctica</option>
      </select>
      <!-- Nuevos botones para Exportar/Importar (ahora para usuarios no logueados) -->
      <div id="local-controls">
        <button id="export-btn">Exportar Progreso</button>
        <input type="file" id="import-file" accept=".json" style="display: none;">
        <button id="import-btn">Importar Progreso</button>
      </div>
      <button id="export-image-btn">Exportar Malla a PDF</button>
      <button id="reset-btn">Reiniciar</button>
      
      <!-- Sección de Información Combinada -->
      <details id="combined-info">
        <summary>Información de la Carrera</summary>
        <div>
          <ul>
            <li>Sede: Chillán</li>
            <li>Modalidad: Presencial</li>
            <li>Jornada: Diurna</li>
            <li>Arancel 2025: $5.346.000</li>
            <li>Matrícula: $275.000</li>
            <li>Código de postulación: 58202</li>
            <li>Duración: 11 Semestres</li>
          </ul>
        </div>
      </details>
    </div>
  </div>

  <!-- CONTENIDO PRINCIPAL -->
  <div id="content-wrapper">
    <!-- Barra lateral izquierda con Leyenda y Widgets -->
    <div id="left-sidebar">
      <!-- LEYENDA ÁREAS -->
      <div id="legend">
        <table>
          <tr><th>ÁREAS DE FORMACIÓN</th></tr>
          <tr><td><span class="dot area-espiritual"></span>Espiritual<span id="creditos-espiritual">0</span></td></tr>
          <tr><td><span class="dot area-general"></span>General<span id="creditos-general">0</span></td></tr>
          <tr><td><span class="dot area-profesional"></span>Profesional<span id="creditos-profesional">0</span></td></tr>
          <tr><td><span class="dot area-especialidad"></span>Especialidad<span id="creditos-especialidad">0</span></td></tr>
          <tr><td><span class="dot area-practica"></span>Práctica<span id="creditos-practica">0</span></td></tr>
        </table>
      </div>

      <!-- Panel de Widgets -->
      <div id="widgets-panel">
        <h3>Recursos Rápidos</h3>
        <div class="widget-card">
          <h4>Drive de la Carrera</h4>
          <a href="https://drive.google.com/drive/folders/1ts_jjP9MPqLo5sXeXgoDHL8_3fO_DXCm?hl=es" target="_blank">Acceder al Drive</a>
        </div>
        <div class="widget-card">
          <h4>Biblioteca UNACH</h4>
          <a href="https://biblioteca.unach.cl/basesdatossuscritas/" target="_blank">Ir a la Biblioteca</a>
        </div>
        <div class="widget-card">
          <h4>Google Académico</h4>
          <a href="https://scholar.google.es/?hl=es" target="_blank">Buscar Artículos</a>
        </div>
        <div class="widget-card calc-box">
            <a href="https://calculatodo.com/calcular-promedio-ponderado-notas" target="_blank">
            Calcular mi nota para aprobar
            </a>
        </div>
        <div class="widget-card calc-box">
            <a href="https://escaladenotas.cl/" target="_blank">
            Calcular nota según puntaje
            </a>
        </div>
        <details class="widget-card" id="calendar-widget">
          <summary><h4>Calendario</h4></summary>
          <div id="calendar-content">
            <div id="calendar-header">
              <button id="prev-month">&lt;</button>
              <h5 id="current-month-year"></h5>
              <button id="next-month">&gt;</button>
            </div>
            <div id="calendar-grid">
              <div class="day-name">Lun</div>
              <div class="day-name">Mar</div>
              <div class="day-name">Mié</div>
              <div class="day-name">Jue</div>
              <div class="day-name">Vie</div>
              <div class="day-name">Sáb</div>
              <div class="day-name">Dom</div>
              <!-- Days will be generated here by JS -->
            </div>
          </div>
        </details>
      </div>
    </div>

    <!-- MALLA -->
    <div id="malla-container">
      <div id="malla">
        <!-- Años y semestres se mantienen igual -->
        <!-- Año 1 -->
        <div class="year" data-year="1">
          <div class="year-label">
            <span>1° AÑO</span>
            <div class="horas-sellos-btn">Horas sellos requeridas 25</div>
          </div>
          <div class="semestre" data-sem="1">
            <div class="progress"><div class="progress-fill"></div></div>
            <div class="ramo" data-code="QYFCCR600" data-area="espiritual" data-creditos="2" data-desc="Estudio de la cosmovisión cristiana y su impacto en la vida y la ciencia.">
              <span class="dot area-espiritual"></span>Cosmovisión Cristiana y Revelación
            </div>
            <div class="ramo" data-code="QYFMPF600" data-area="profesional" data-creditos="5" data-desc="Fundamentos matemáticos esenciales para las ciencias farmacéuticas.">
              <span class="dot area-profesional"></span>Matemática para Farmacia
            </div>
            <div class="ramo" data-code="QYFMYE600" data-area="profesional" data-creditos="5" data-desc="Estudio de la morfología, histología y embriología humana.">
              <span class="dot area-profesional"></span>Morfohistología y Embriología
            </div>
            <div class="ramo" data-code="QYFQGE601" data-area="profesional" data-creditos="6" data-desc="Principios fundamentales de la química general.">
              <span class="dot area-profesional"></span>Química General I
            </div>
            <div class="ramo" data-code="QYFFPF600" data-area="profesional" data-creditos="5" data-desc="Conceptos de física aplicados a la farmacia.">
              <span class="dot area-profesional"></span>Física para Farmacia
            </div>
            <div class="ramo" data-code="QYFICF600" data-area="profesional" data-creditos="2" data-desc="Introducción a las Ciencias Farmacéuticas.">
              <span class="dot area-profesional"></span>Introducción a las Ciencias Farmacéuticas
            </div>
            <div class="ramo" data-code="QYFING601" data-area="general" data-creditos="2" data-desc="Desarrollo de habilidades básicas en el idioma inglés.">
              <span class="dot area-general"></span>Inglés I
            </div>
            <div class="ramo" data-code="QYFTAP601" data-area="general" data-creditos="3" data-desc="Taller para el desarrollo de habilidades de estudio y aprendizaje.">
              <span class="dot area-general"></span>Taller de Habilidades de Aprendizaje I
            </div>
          </div>
          <div class="semestre" data-sem="2">
            <div class="progress"><div class="progress-fill"></div></div>
            <div class="ramo" data-code="QYFATB600" data-area="espiritual" data-creditos="2" data-desc="Análisis de la naturaleza humana desde una perspectiva bíblica.">
              <span class="dot area-espiritual"></span>Antropología Bíblica
            </div>
            <div class="ramo" data-code="QYFFQF600" data-req="QYFFPF600" data-area="profesional" data-creditos="5" data-desc="Estudio de los principios fisicoquímicos relevantes para la farmacia.">
              <span class="dot area-profesional"></span>Físicoquímica para Farmacia
            </div>
            <div class="ramo" data-code="QYFAPF600"  data-req="QYFMYE600" data-area="profesional" data-creditos="6" data-desc="Estudio de la anatomía humana aplicada a la farmacia.">
              <span class="dot area-profesional"></span>Anatomía para Farmacia
            </div>
            <div class="ramo" data-code="QYFQGE602" data-req="QYFQGE601" data-area="profesional" data-creditos="6" data-desc="Continuación de los principios de química general, con énfasis en reacciones.">
              <span class="dot area-profesional"></span>Química General II
            </div>
            <div class="ramo" data-code="QYFCYL600" data-area="general" data-creditos="3" data-desc="Desarrollo de habilidades de comunicación efectiva y liderazgo.">
              <span class="dot area-general"></span>Comunicación y Liderazgo
            </div>
            <div class="ramo" data-code="QYFGPF600"  data-req="QYFMYE600" data-area="profesional" data-creditos="3" data-desc="Principios de genética y su aplicación en farmacia.">
              <span class="dot area-profesional"></span>Genética para Farmacia
            </div>
            <div class="ramo" data-code="QYFING602" data-req="QYFING601" data-area="general" data-creditos="2" data-desc="Continuación del desarrollo de habilidades en inglés.">
              <span class="dot area-general"></span>Inglés II
            </div>
            <div class="ramo" data-code="QYFTAP602" data-area="general" data-creditos="3" data-desc="Taller avanzado de habilidades de aprendizaje y gestión del tiempo.">
              <span class="dot area-general"></span>Taller de Habilidades de Aprendizaje II
            </div>
          </div>
        </div>
        <!-- Año 2 -->
        <div class="year" data-year="2">
          <div class="year-label">
            <span>2° AÑO</span>
            <div class="horas-sellos-btn">Horas sellos requeridas 25</div>
          </div>
          <div class="semestre" data-sem="3">
            <div class="progress"><div class="progress-fill"></div></div>
            <div class="ramo" data-code="QYFCRE600" data-area="espiritual" data-creditos="2" data-desc="Exploración de la relación entre la ciencia y la fe religiosa.">
              <span class="dot area-espiritual"></span>Ciencia y Religión
            </div>
            <div class="ramo" data-code="QYFBGF600" data-req="QYFMYE600" data-area="profesional" data-creditos="6" data-desc="Estudio de los procesos bioquímicos fundamentales para la farmacia.">
              <span class="dot area-profesional"></span>Bioquímica General para Farmacia
            </div>
            <div class="ramo" data-code="QYFFIF600" data-req="QYFAPF600" data-area="profesional" data-creditos="6" data-desc="Estudio de la fisiología de los sistemas del cuerpo humano.">
              <span class="dot area-profesional"></span>Fisiología para Farmacia
            </div>
            <div class="ramo" data-code="QYFQAN600"  data-req="QYFQGE602" data-area="profesional" data-creditos="6" data-desc="Principios y técnicas de la química analítica.">
              <span class="dot area-profesional"></span>Química Analítica
            </div>
            <div class="ramo" data-code="QYFQOR601" data-req="QYFQGE602" data-area="profesional" data-creditos="6" data-desc="Introducción a la química de compuestos orgánicos.">
              <span class="dot area-profesional"></span>Química Orgánica I
            </div>
            <div class="ramo" data-code="QYFITF600" data-req="QYFING602" data-area="general" data-creditos="3" data-desc="Desarrollo de habilidades de lectura y comprensión de textos técnicos en inglés.">
              <span class="dot area-general"></span>Inglés Técnico para Farmacia
            </div>
            <div class="ramo" data-code="QYFMIP600" data-area="profesional" data-creditos="3" data-desc="Estudio de microorganismos y parásitos de interés farmacéutico.">
              <span class="dot area-profesional"></span>Microbiología y Parasitología
            </div>
            <div class="ramo" data-code="QYFCMP601" data-area="general" data-creditos="1" data-desc="Asignatura complementaria de libre elección.">
              <span class="dot area-general"></span>Complementario I
            </div>
          </div>
          <div class="semestre" data-sem="4">
            <div class="progress"><div class="progress-fill"></div></div>
            <div class="ramo" data-code="QYFEBI600" data-area="espiritual" data-creditos="2" data-desc="Profundización en las enseñanzas fundamentales de la Biblia.">
              <span class="dot area-espiritual"></span>Enseñanzas de la Biblia
            </div>
            <div class="ramo" data-code="QYFTNA610"  data-req="QYFFIF600" data-area="profesional" data-creditos="6" data-desc="Estudio de diversas terapias naturales y su aplicación.">
              <span class="dot area-profesional"></span>Terapias Naturales
            </div>
            <div class="ramo" data-code="QYFFPF610" data-req="QYFFIF600" data-area="profesional" data-creditos="6" data-desc="Estudio de los mecanismos de las enfermedades y sus manifestaciones.">
              <span class="dot area-profesional"></span>Fisiopatología para Farmacia
            </div>
            <div class="ramo" data-code="QYFAIM610" data-req="QYFQAN600" data-area="profesional" data-creditos="6" data-desc="Análisis de instrumentos y métodos para el control de calidad de medicamentos.">
              <span class="dot area-profesional"></span>Análisis Instrumental y de Medicamentos
            </div>
            <div class="ramo" data-code="QYFQOR602" data-req="QYFQOR601" data-area="profesional" data-creditos="6" data-desc="Continuación de la química orgánica, con énfasis en reacciones y síntesis.">
              <span class="dot area-profesional"></span>Química Orgánica II
            </div>
            <div class="ramo" data-code="QYFCMP602"  data-req="QYFCMP601" data-area="general" data-creditos="1" data-desc="Asignatura complementaria de libre elección.">
              <span class="dot area-general"></span>Complementario II
            </div>
          </div>
        </div>
        <!-- Año 3 -->
        <div class="year" data-year="3">
          <div class="year-label">
            <span>3° AÑO</span>
            <div class="horas-sellos-btn">Horas sellos requeridas 25</div>
          </div>
          <div class="semestre" data-sem="5">
            <div class="progress"><div class="progress-fill"></div></div>
            <div class="ramo" data-code="QYFFYS600" data-area="espiritual" data-creditos="2" data-desc="Análisis de la estructura y dinámica de la familia y la sociedad.">
              <span class="dot area-espiritual"></span>Familia y Sociedad
            </div>
            <div class="ramo" data-code="QYFIYH600"  data-req="QYFFPF610" data-area="profesional" data-creditos="5" data-desc="Estudio del sistema inmune y los componentes de la sangre.">
              <span class="dot area-profesional"></span>Inmunología y Hematología
            </div>
            <div class="ramo" data-code="QYFLFA600" data-req="QYFICF600" data-area="especialidad" data-creditos="4" data-desc="Marco legal que rige la actividad farmacéutica y la autoridad sanitaria.">
              <span class="dot area-especialidad"></span>Legislación Farmacéutica y Autorización Sanitaria
            </div>
            <div class="ramo" data-code="QYFFAQ601" data-req="QYFFQF600,QYFQOR602" data-area="profesional" data-creditos="6" data-desc="Estudio de la relación entre la estructura química y la actividad biológica de los fármacos.">
              <span class="dot area-profesional"></span>Farmacoquímica I
            </div>
            <div class="ramo" data-code="QYFFAR611"  data-req="QYFFPF610" data-area="profesional" data-creditos="6" data-desc="Introducción a los principios de la farmacología y acción de los fármacos.">
              <span class="dot area-profesional"></span>Farmacología I
            </div>
            <div class="ramo" data-code="QYFTFA601" data-req="QYFQOR602" data-area="profesional" data-creditos="6" data-desc="Principios de formulación y producción de formas farmacéuticas.">
              <span class="dot area-profesional"></span>Tecnología Farmacéutica I
            </div>
            <div class="ramo" data-code="QYFCMP603"  data-req="QYFCMP602" data-area="general" data-creditos="1" data-desc="Asignatura complementaria de libre elección.">
              <span class="dot area-general"></span>Complementario III
            </div>
          </div>
          <div class="semestre" data-sem="6">
            <div class="progress"><div class="progress-fill"></div></div>
            <div class="ramo" data-code="QYFSRS600" data-area="general" data-creditos="2" data-desc="Importancia del autocuidado, responsabilidad social y medioambiente.">
              <span class="dot area-general"></span>Salud y Autocuidado, Responsabilidad Social y Medioambiente
            </div>
            <div class="ramo" data-code="QYFBQC600"  data-req="QYFBGF600" data-area="profesional" data-creditos="4" data-desc="Aplicación de la bioquímica en el diagnóstico y seguimiento clínico.">
              <span class="dot area-profesional"></span>Bioquímica Clínica
            </div>
            <div class="ramo" data-code="QYFNBC600" data-area="profesional" data-creditos="5" data-desc="Estudio de la nutrición y el análisis de alimentos en el contexto clínico.">
              <span class="dot area-profesional"></span>Nutrición y Bromatología Clínicas
            </div>
            <div class="ramo" data-code="QYFFAR612"  data-req="QYFFAR611" data-area="profesional" data-creditos="6" data-desc="Profundización en la farmacología de diferentes sistemas orgánicos.">
              <span class="dot area-profesional"></span>Farmacología II
            </div>
            <div class="ramo" data-code="QYFFAQ602" data-req="QYFFAQ601" data-area="profesional" data-creditos="6" data-desc="Continuación del estudio de la relación estructura-actividad de los fármacos.">
              <span class="dot area-profesional"></span>Farmacoquímica II
            </div>
            <div class="ramo" data-code="QYFTFA602" data-req="QYFTFA601" data-area="profesional" data-creditos="6" data-desc="Formulación y evaluación de formas farmacéuticas avanzadas.">
              <span class="dot area-profesional"></span>Tecnología Farmacéutica II
            </div>
            <div class="ramo" data-code="QYFCMP604"  data-req="QYFCMP603" data-area="general" data-creditos="1" data-desc="Asignatura complementaria de libre elección.">
              <span class="dot area-general"></span>Complementario IV
            </div>
          </div>
        </div>
        <!-- Año 4 -->
        <div class="year" data-year="4">
          <div class="year-label">
            <span>4° AÑO</span>
            <div class="horas-sellos-btn">Horas sellos requeridas 25</div>
          </div>
          <div class="semestre" data-sem="7">
            <div class="progress"><div class="progress-fill"></div></div>
            <div class="ramo" data-code="QYFMYS600" data-area="espiritual" data-creditos="2" data-desc="Principios de misión y servicio en el contexto cristiano.">
              <span class="dot area-espiritual"></span>Misión y Servicio
            </div>
            <div class="ramo" data-code="QYFMIF600" data-area="profesional" data-creditos="3" data-desc="Diseño y ejecución de proyectos de investigación en farmacia.">
              <span class="dot area-profesional"></span>Metodología de la Investigación para Farmacia
            </div>
            <div class="ramo" data-code="QYFTOX600"  data-req="QYFFAR612" data-area="especialidad" data-creditos="6" data-desc="Estudio de los efectos tóxicos de sustancias y su manejo.">
              <span class="dot area-especialidad"></span>Toxicología
            </div>
            <div class="ramo" data-code="QYFFCA600" data-req="QYFFAR612" data-area="especialidad" data-creditos="5" data-desc="Rol del farmacéutico en la comunidad y atención asistencial.">
              <span class="dot area-especialidad"></span>Farmacia Comunitaria y Asistencial
            </div>
            <div class="ramo" data-code="QYFFGN600" data-area="especialidad" data-creditos="5" data-desc="Estudio de fármacos de origen natural.">
              <span class="dot area-especialidad"></span>Farmacognosia
            </div>
            <div class="ramo" data-code="QYFTCO600"  data-req="QYFTFA602" data-area="profesional" data-creditos="5" data-desc="Principios y formulación de productos cosméticos.">
              <span class="dot area-profesional"></span>Tecnología Cosmética
            </div>
            <div class="ramo" data-code="QYFPLC600" data-req="QYFIYH600,QYFMIP600" data-area="practica" data-creditos="4" data-desc="Práctica en laboratorio clínico, realizando análisis y diagnósticos.">
              <span class="dot area-practica"></span>Práctica Laboratorio Clínico
            </div>
          </div>
          <div class="semestre" data-sem="8">
            <div class="progress"><div class="progress-fill"></div></div>
            <div class="ramo" data-code="QYFEVP600" data-area="espiritual" data-creditos="2" data-desc="Análisis de la ética y valores en el ejercicio profesional.">
              <span class="dot area-espiritual"></span>Ética y Vida Profesional
            </div>
            <div class="ramo" data-code="QYFBEA600" data-area="profesional" data-creditos="4" data-desc="Aplicación de métodos estadísticos en la investigación farmacéutica.">
              <span class="dot area-profesional"></span>Bioestadística Aplicada
            </div>
            <div class="ramo" data-code="QYFFVT600" data-req="QYFLFA600" data-area="especialidad" data-creditos="4" data-desc="Sistemas de vigilancia de la seguridad de medicamentos y tecnologías.">
              <span class="dot area-especialidad"></span>Farmacovigilancia y Tecnovigilancia
            </div>
            <div class="ramo" data-code="QYFFCL601" data-req="QYFFCA600" data-area="especialidad" data-creditos="6" data-desc="Aplicación de conocimientos farmacológicos en casos clínicos.">
              <span class="dot area-especialidad"></span>Farmacia Clínica I
            </div>
            <div class="ramo" data-code="QYFSPE600" data-req="QYFMIP600" data-area="profesional" data-creditos="5" data-desc="Principios de salud pública y epidemiología.">
              <span class="dot area-profesional"></span>Salud Pública y Epidemiología
            </div>
            <div class="ramo" data-code="QYFCCA610"  data-req="QYFTCO600" data-area="profesional" data-creditos="5" data-desc="Métodos y normas para el control de calidad de productos farmacéuticos.">
              <span class="dot area-profesional"></span>Control de Calidad
            </div>
            <div class="ramo" data-code="QYFPFP600" data-req="QYFFCA600" data-area="practica" data-creditos="4" data-desc="Práctica profesional en farmacias privadas.">
              <span class="dot area-practica"></span>Práctica Farmacia Privada
            </div>
          </div>
        </div>
        <!-- Año 5 -->
        <div class="year" data-year="5">
          <div class="year-label">
            <span>5° AÑO</span>
            <div class="horas-sellos-btn">Horas sellos requeridas 25</div>
          </div>
          <div class="semestre" data-sem="9">
            <div class="progress"><div class="progress-fill"></div></div>
            <div class="ramo" data-code="QYFEDF610" data-area="especialidad" data-creditos="2" data-desc="Asignatura electiva para profundizar en un área específica de la farmacia.">
              <span class="dot area-especialidad"></span>Electivo de Farmacia
            </div>
            <div class="ramo" data-code="QYFFCP600" data-area="profesional" data-creditos="3" data-desc="Análisis económico de medicamentos y procesos de compra pública.">
              <span class="dot area-profesional"></span>Farmacoeconomía y Compras Públicas
            </div>
            <div class="ramo" data-code="QYFFCA610" data-req="QYFFCL601" data-area="especialidad" data-creditos="6" data-desc="Aplicación de la farmacocinética en la práctica clínica.">
              <span class="dot area-especialidad"></span>Farmacocinética Aplicada
            </div>
            <div class="ramo" data-code="QYFAFS600" data-req="QYFFCL602" data-area="especialidad" data-creditos="6" data-desc="Seguimiento farmacoterapéutico y atención farmacéutica personalizada.">
              <span class="dot area-especialidad"></span>Atención Farmacéutica y Seguimiento Farmacológico
            </div>
            <div class="ramo" data-code="QYFFCL602" data-req="QYFFCL601" data-area="especialidad" data-creditos="6" data-desc="Casos clínicos avanzados y manejo de terapias farmacológicas.">
              <span class="dot area-especialidad"></span>Farmacia Clínica II
            </div>
            <div class="ramo" data-code="QYFFGE600" data-req="QYFFCL602" data-area="especialidad" data-creditos="4" data-desc="Manejo farmacológico en pacientes geriátricos.">
              <span class="dot area-especialidad"></span>Farmacogeriatría
            </div>
            <div class="ramo" data-code="QYFOCP600" data-req="QYFFCL601" data-area="especialidad" data-creditos="5" data-desc="Manejo farmacológico en oncología y cuidados paliativos.">
              <span class="dot area-especialidad"></span>Oncoterapia y Cuidados Paliativos
            </div>
            <div class="ramo" data-code="QYFSME600" data-area="profesional" data-creditos="4" data-desc="Introducción a la salud mental y su relación con la farmacología.">
              <span class="dot area-profesional"></span>Salud Mental
            </div>
            <div class="ramo" data-code="QYFPFC600" data-req="QYFPFP600" data-area="practica" data-creditos="4" data-desc="Práctica en farmacias comunitarias y atención primaria de salud.">
              <span class="dot area-practica"></span>Práctica en Farmacia Comunitaria APS
            </div>
          </div>
          <div class="semestre" data-sem="10">
            <div class="progress"><div class="progress-fill"></div></div>
            <div class="ramo" data-code="QYFTFC641" data-req="QYFMIF600" data-area="profesional" data-creditos="7" data-desc="Taller de Formulación y Control de Calidad I.">
              <span class="dot area-profesional"></span>TFC I
            </div>
            <div class="ramo" data-code="QYFTFC642" data-req="QYFTFC641" data-area="profesional" data-creditos="9" data-desc="Taller de Formulación y Control de Calidad II.">
              <span class="dot area-profesional"></span>TFC II
            </div>
            <div class="ramo" data-code="QYFPFA610" data-req="QYFPLC600" data-area="practica" data-creditos="4" data-desc="Práctica profesional en farmacias asistenciales (hospitales, clínicas).">
              <span class="dot area-practica"></span>Práctica Farmacia Asistencial
            </div>
          </div>
        </div>
        <!-- Año 6 -->
        <div class="year" data-year="6">
          <div class="year-label">
            <span>6° AÑO</span>
            <div class="horas-sellos-btn">Horas sellos requeridas 25</div>
          </div>
          <div class="semestre" data-sem="11">
            <div class="progress"><div class="progress-fill"></div></div>
            <div class="ramo" data-code="QYFPRO636" data-req="QYFAFS600,QYFFCA610,QYFFCP600,QYFFGE600,QYFOCP600,QYFPFA610,QYFSME600,QYFTFC642" data-area="practica" data-creditos="30" data-desc="Práctica profesional intensiva en un entorno farmacéutico.">
              <span class="dot area-practica"></span>Práctica Profesional/Internado
            </div>
          </div>
          <div class="semestre empty"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Información de Ramo -->
  <div id="ramo-info-modal" class="modal-backdrop">
    <div class="modal-content">
      <button class="modal-close-button">&times;</button>
      <h3 class="modal-title" id="modal-ramo-nombre"></h3>
      <div class="modal-info">
        <p><strong>Código:</strong> <span id="modal-ramo-code"></span></p>
        <p><strong>Área:</strong> <span id="modal-ramo-area"></span></p>
        <p><strong>Créditos:</strong> <span id="modal-ramo-creditos"></span></p>
        <p><strong>Prerrequisitos:</strong> <span id="modal-ramo-req"></span></p>
        <p><strong>Descripción:</strong> <span id="modal-ramo-desc"></span></p>
      </div>
      <div class="modal-buttons">
        <button id="modal-btn-aprobado" class="btn-aprobado">Marcar como Aprobado</button>
        <button id="modal-btn-desmarcar" class="btn-desmarcar">Desmarcar</button>
        <button id="modal-btn-close" class="btn-close">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Registro de Usuario -->
    <div id="register-modal" class="modal-backdrop">
        <div class="modal-content">
            <button class="modal-close-button">&times;</button>
            <h3 class="modal-title">Crear una Cuenta</h3>
            <input type="email" id="register-email" placeholder="Correo electrónico" required>
            <input type="password" id="register-password" placeholder="Contraseña (mín. 6 caracteres)" required>
            <div class="modal-buttons" style="justify-content: center; flex-direction: column; gap: 10px;">
                <button id="register-submit-btn" class="btn-aprobado">Registrarse</button>
                <button id="google-register-btn" class="btn-google">
                    <img src="logo-google.png" alt="Google logo">
                    <span>Registrarse con Google</span>
                </button>
            </div>
        </div>
    </div>


  <!-- Modal de Confirmación Personalizado (para Reiniciar) -->
  <div id="custom-confirm-modal" class="modal-backdrop custom-confirm-modal">
    <div class="modal-content">
      <h3 class="modal-title">Reiniciar Progreso</h3>
      <p id="confirm-message">¿Estás seguro de que quieres reiniciar todo el progreso? Esto no se puede deshacer.</p>
      <div class="modal-buttons">
        <button id="confirm-reset-yes" class="btn-desmarcar">Sí, reiniciar</button>
        <button id="confirm-reset-no" class="btn-close">No, cancelar</button>
      </div>
    </div>
  </div>

  <!-- Nuevo Modal para el Mensaje del Tr._nico -->
  <div id="tr-nico-message-modal" class="modal-backdrop custom-alert-modal">
    <div class="modal-content">
      <button class="modal-close-button">&times;</button>
      <h3 class="modal-title">Mensaje Especial</h3>
      <p>Regalito del tr._nico para mis compañeros químicos farmacéuticos.</p>
      <div class="modal-buttons">
        <button class="btn-close" id="tr-nico-modal-close-btn">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Nuevo Modal de Felicidades por Semestre Completado -->
  <div id="semester-complete-modal" class="modal-backdrop">
    <div class="modal-content">
      <h3 class="modal-title">¡FELICIDADES!</h3>
      <p id="semester-complete-message"></p>
      <div class="modal-buttons">
        <button class="btn-close" id="semester-complete-modal-close-btn">¡Entendido!</button>
      </div>
    </div>
  </div>

  <!-- Script para jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged,
        GoogleAuthProvider,
        signInWithPopup,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        setDoc, 
        getDoc 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // TODO: Add your web app's Firebase configuration
    // IMPORTANTE: Reemplaza el siguiente objeto con la configuración de tu propio proyecto de Firebase.
    // Puedes obtener esta configuración desde la consola de Firebase en:
    // Configuración del proyecto > General > Tus apps > App web > Configuración de Firebase > CDN.
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_AUTH_DOMAIN",
      projectId: "TU_PROJECT_ID",
      storageBucket: "TU_STORAGE_BUCKET",
      messagingSenderId: "TU_MESSAGING_SENDER_ID",
      appId: "TU_APP_ID"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const googleProvider = new GoogleAuthProvider();

    // --- DOM References ---
    const ramos = document.querySelectorAll('.ramo');
    const busc  = document.getElementById('buscador');
    const areaF = document.getElementById('area-filter');
    const zoomR = document.getElementById('zoom');
    const clk   = document.getElementById('clock');
    const themeSelector = document.getElementById('theme-selector');
    const container = document.getElementById('malla-container');

    // Auth UI elements
    const loginBtn = document.getElementById('login-btn');
    const loginDropdown = document.getElementById('login-dropdown');
    const loginEmailInput = document.getElementById('login-email');
    const loginPasswordInput = document.getElementById('login-password');
    const loginSubmitBtn = document.getElementById('login-submit-btn');
    const googleLoginBtn = document.getElementById('google-login-btn');
    const createAccountLink = document.getElementById('create-account-link');
    const userInfoDiv = document.getElementById('user-info');
    const userNameSpan = document.getElementById('user-name');
    const logoutBtn = document.getElementById('logout-btn');
    const localControls = document.getElementById('local-controls');

    // Register Modal elements
    const registerModal = document.getElementById('register-modal');
    const registerEmailInput = document.getElementById('register-email');
    const registerPasswordInput = document.getElementById('register-password');
    const registerSubmitBtn = document.getElementById('register-submit-btn');
    const googleRegisterBtn = document.getElementById('google-register-btn');
    const registerModalCloseBtn = registerModal.querySelector('.modal-close-button');
    
    // Other Modals
    const ramoInfoModal = document.getElementById('ramo-info-modal');
    const customConfirmModal = document.getElementById('custom-confirm-modal');
    const trNicoMessageModal = document.getElementById('tr-nico-message-modal');
    const semesterCompleteModal = document.getElementById('semester-complete-modal');

    // --- State Variables ---
    let currentUser = null;
    let aprobados = new Set();
    let completedSem = new Set();
    let completedYear = new Set();
    const totalRamos = ramos.length;

    // --- Data Persistence Functions (Firebase) ---

    async function saveUserData() {
        if (!currentUser) {
            // If no user is logged in, save to localStorage as a fallback
            localStorage.setItem('aprobados', JSON.stringify([...aprobados]));
            localStorage.setItem('completedSem', JSON.stringify([...completedSem]));
            localStorage.setItem('completedYear', JSON.stringify([...completedYear]));
            localStorage.setItem('theme', themeSelector.value);
            return;
        }
        try {
            const userDocRef = doc(db, "users", currentUser.uid);
            const dataToSave = {
                aprobados: [...aprobados],
                completedSem: [...completedSem],
                completedYear: [...completedYear],
                theme: themeSelector.value
            };
            await setDoc(userDocRef, dataToSave);
        } catch (error) {
            console.error("Error saving user data to Firestore: ", error);
            showCustomAlert("Error al guardar tu progreso en la nube.");
        }
    }

    async function loadUserData() {
        if (!currentUser) {
            // Load from localStorage if no user
            aprobados = new Set(JSON.parse(localStorage.getItem('aprobados')) || []);
            completedSem = new Set(JSON.parse(localStorage.getItem('completedSem')) || []);
            completedYear = new Set(JSON.parse(localStorage.getItem('completedYear')) || []);
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
            updateUI();
            return;
        }

        const userDocRef = doc(db, "users", currentUser.uid);
        try {
            const docSnap = await getDoc(userDocRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                aprobados = new Set(data.aprobados || []);
                completedSem = new Set(data.completedSem || []);
                completedYear = new Set(data.completedYear || []);
                setTheme(data.theme || 'light');
            } else {
                // No data found for this user, start fresh
                aprobados = new Set();
                completedSem = new Set();
                completedYear = new Set();
                setTheme('light');
            }
        } catch (error) {
            console.error("Error loading user data from Firestore: ", error);
            showCustomAlert("Error al cargar tu progreso desde la nube.");
            // Fallback to local storage on error
            loadLocalData();
        }
        updateUI();
    }
    
    function loadLocalData() {
        aprobados = new Set(JSON.parse(localStorage.getItem('aprobados')) || []);
        completedSem = new Set(JSON.parse(localStorage.getItem('completedSem')) || []);
        completedYear = new Set(JSON.parse(localStorage.getItem('completedYear')) || []);
        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme);
    }

    // --- Auth State Change Handler ---

    onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        if (user) {
            // User is signed in
            userNameSpan.textContent = user.displayName || user.email;
            loginBtn.style.display = 'none';
            loginDropdown.classList.remove('show');
            userInfoDiv.style.display = 'flex';
            localControls.style.display = 'none'; // Hide local import/export
            await loadUserData();
        } else {
            // User is signed out
            loginBtn.style.display = 'block';
            userInfoDiv.style.display = 'none';
            localControls.style.display = 'flex'; // Show local import/export
            loadLocalData(); // Load from localStorage
            updateUI();
        }
    });
    
    // --- UI Update & Theme Functions ---
    
    function setTheme(themeName) {
        document.body.className = ''; // Clear all classes
        document.body.classList.add(themeName);
        themeSelector.value = themeName;
    }

    themeSelector.addEventListener('change', (e) => {
      setTheme(e.target.value);
      saveUserData(); // Save theme change
    });
    
    // --- Event Listeners for Auth ---

    loginBtn.addEventListener('click', () => {
        loginDropdown.classList.toggle('show');
    });

    document.addEventListener('click', (e) => {
        if (!loginBtn.contains(e.target) && !loginDropdown.contains(e.target)) {
            loginDropdown.classList.remove('show');
        }
    });

    createAccountLink.addEventListener('click', () => {
        loginDropdown.classList.remove('show');
        registerModal.classList.add('show');
    });

    registerModalCloseBtn.addEventListener('click', () => registerModal.classList.remove('show'));

    // Email/Password Login
    loginSubmitBtn.addEventListener('click', async () => {
        const email = loginEmailInput.value;
        const password = loginPasswordInput.value;
        if (!email || !password) {
            showCustomAlert("Por favor, ingresa correo y contraseña.");
            return;
        }
        try {
            await signInWithEmailAndPassword(auth, email, password);
            loginDropdown.classList.remove('show');
        } catch (error) {
            console.error("Login Error:", error);
            showCustomAlert("Error al iniciar sesión: " + error.message);
        }
    });
    
    // Email/Password Registration
    registerSubmitBtn.addEventListener('click', async () => {
        const email = registerEmailInput.value;
        const password = registerPasswordInput.value;
        if (!email || !password) {
            showCustomAlert("Por favor, ingresa correo y contraseña.");
            return;
        }
        if (password.length < 6) {
            showCustomAlert("La contraseña debe tener al menos 6 caracteres.");
            return;
        }
        try {
            await createUserWithEmailAndPassword(auth, email, password);
            registerModal.classList.remove('show');
        } catch (error) {
            console.error("Registration Error:", error);
            showCustomAlert("Error al registrarse: " + error.message);
        }
    });

    // Google Sign-In (for both login and register)
    const handleGoogleSignIn = async () => {
        try {
            await signInWithPopup(auth, googleProvider);
            loginDropdown.classList.remove('show');
            registerModal.classList.remove('show');
        } catch (error) {
            console.error("Google Sign-In Error:", error);
            showCustomAlert("Error con el inicio de sesión de Google: " + error.message);
        }
    };
    googleLoginBtn.addEventListener('click', handleGoogleSignIn);
    googleRegisterBtn.addEventListener('click', handleGoogleSignIn);

    // Logout
    logoutBtn.addEventListener('click', async () => {
        try {
            await signOut(auth);
        } catch (error) {
            console.error("Logout Error:", error);
            showCustomAlert("Error al cerrar sesión.");
        }
    });

    // --- Rest of the application logic ---
    
    function updateClock(){
      const now = new Date();
      const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
      clk.textContent = now.toLocaleDateString('es-ES', options);
    }
    setInterval(updateClock,1000);
    updateClock();

    zoomR.addEventListener('input', e => {
      container.style.transform = `scale(${e.target.value/100})`;
    });
    container.style.transform = `scale(${zoomR.value/100})`;

    async function cascadeRemove(code){
      aprobados.delete(code);
      const dependentRamos = document.querySelectorAll(`.ramo[data-req*="${code}"]`);
      for (const r of dependentRamos) {
        if (aprobados.has(r.dataset.code)) {
          await cascadeRemove(r.dataset.code);
        }
      }
    }

    function updateUI(){
      let totalCreditosAprobados = 0;
      let creditosPorArea = { espiritual: 0, general: 0, profesional: 0, especialidad: 0, practica: 0 };

      document.querySelectorAll('.semestre').forEach(s=>{
        const hijos = s.querySelectorAll('.ramo');
        const prog  = s.querySelector('.progress-fill');
        if (!prog) return;

        let aproS = 0;
        hijos.forEach(r=>{
          const code = r.dataset.code;
          const deps = r.dataset.req ? r.dataset.req.split(',') : [];
          r.classList.remove('aprobado','desbloqueado','highlight');

          if(aprobados.has(code)){
            r.classList.add('aprobado');
            aproS++;
            const creditos = parseInt(r.dataset.creditos);
            const area = r.dataset.area;
            if (!isNaN(creditos)) {
                totalCreditosAprobados += creditos;
                if (creditosPorArea[area] !== undefined) {
                    creditosPorArea[area] += creditos;
                }
            }
          } else if(deps.length > 0 && deps.every(q => aprobados.has(q))){ // *** FIX: Check deps.length > 0 ***
            r.classList.add('desbloqueado');
          }
        });

        prog.style.width = hijos.length > 0 ? (aproS / hijos.length * 100) + '%' : '0%';
        
        const sem = s.dataset.sem;
        if(aproS === hijos.length && hijos.length > 0 && !completedSem.has(sem)){
          showSemesterCompleteModal(`¡Felicidades, sobreviviste al ${sem}° semestre!`);
          completedSem.add(sem);
          saveUserData();
        }
      });

      document.getElementById('contador').textContent = Math.round(aprobados.size / totalRamos * 100) + '%';
      document.getElementById('creditos-total').textContent = totalCreditosAprobados;
      document.getElementById('creditos-espiritual').textContent = creditosPorArea.espiritual;
      document.getElementById('creditos-general').textContent = creditosPorArea.general;
      document.getElementById('creditos-profesional').textContent = creditosPorArea.profesional;
      document.getElementById('creditos-especialidad').textContent = creditosPorArea.especialidad;
      document.getElementById('creditos-practica').textContent = creditosPorArea.practica;

      document.querySelectorAll('.year').forEach(y=>{
        const year = y.dataset.year;
        const sems = y.querySelectorAll('.semestre:not(.empty)');
        const allSemestersComplete = [...sems].every(s => parseFloat(s.querySelector('.progress-fill').style.width) === 100);
        
        if (allSemestersComplete) {
            y.setAttribute('data-year-complete','');
            if(!completedYear.has(year)) {
                showSemesterCompleteModal(`¡Felicidades, completaste el ${year}° año!`);
                completedYear.add(year);
                saveUserData();
            }
        } else {
            y.removeAttribute('data-year-complete');
        }
      });
    }

    function showCustomAlert(message, title = "Información") {
        const alertModal = document.getElementById('tr-nico-message-modal');
        alertModal.querySelector('.modal-title').textContent = title;
        alertModal.querySelector('p').textContent = message;
        alertModal.classList.add('show');
    }

    function showRamoInfoModal(ramoElement) {
        const code = ramoElement.dataset.code;
        ramoInfoModal.querySelector('#modal-ramo-nombre').textContent = ramoElement.textContent.trim();
        ramoInfoModal.querySelector('#modal-ramo-code').textContent = code;
        ramoInfoModal.querySelector('#modal-ramo-area').textContent = ramoElement.dataset.area;
        ramoInfoModal.querySelector('#modal-ramo-creditos').textContent = ramoElement.dataset.creditos || 'N/A';
        const reqRamo = document.querySelector(`.ramo[data-code="${ramoElement.dataset.req}"]`);
        ramoInfoModal.querySelector('#modal-ramo-req').textContent = reqRamo ? reqRamo.textContent.trim() : (ramoElement.dataset.req || 'Ninguno');
        ramoInfoModal.querySelector('#modal-ramo-desc').textContent = ramoElement.dataset.desc || 'No hay descripción.';
        
        if (aprobados.has(code)) {
            ramoInfoModal.querySelector('#modal-btn-aprobado').style.display = 'none';
            ramoInfoModal.querySelector('#modal-btn-desmarcar').style.display = 'inline-block';
        } else {
            ramoInfoModal.querySelector('#modal-btn-aprobado').style.display = 'inline-block';
            ramoInfoModal.querySelector('#modal-btn-desmarcar').style.display = 'none';
        }
        
        ramoInfoModal.dataset.currentCode = code;
        ramoInfoModal.classList.add('show');
    }

    ramos.forEach(r => r.onclick = () => showRamoInfoModal(r));
    
    ramoInfoModal.querySelector('#modal-btn-aprobado').addEventListener('click', async () => {
        const code = ramoInfoModal.dataset.currentCode;
        const ramoElement = document.querySelector(`.ramo[data-code="${code}"]`);
        const deps = ramoElement.dataset.req ? ramoElement.dataset.req.split(',') : [];

        if (deps.length === 0 || deps.every(q => aprobados.has(q))) {
            aprobados.add(code);
            await saveUserData();
            updateUI();
            ramoInfoModal.classList.remove('show');
        } else {
            const falt = deps.find(q => !aprobados.has(q));
            const nom = document.querySelector(`.ramo[data-code="${falt}"]`).textContent;
            showCustomAlert(`Aún no has aprobado "${nom.trim()}" para tomar este ramo.`);
        }
    });

    ramoInfoModal.querySelector('#modal-btn-desmarcar').addEventListener('click', async () => {
        const code = ramoInfoModal.dataset.currentCode;
        await cascadeRemove(code);
        await saveUserData();
        updateUI();
        ramoInfoModal.classList.remove('show');
    });

    function reset() {
      showCustomConfirm('¿Estás seguro de que quieres reiniciar todo el progreso? Esto no se puede deshacer.', async () => {
        aprobados.clear();
        completedSem.clear();
        completedYear.clear();
        await saveUserData(); // This will save the empty sets to Firestore/localStorage
        updateUI();
        hideCustomConfirm();
      });
    }
    document.getElementById('reset-btn').addEventListener('click', reset);

    // --- Other modal handlers ---
    function setupModal(modalId, openTriggerId, closeBtnClass) {
        const modal = document.getElementById(modalId);
        if(openTriggerId) document.getElementById(openTriggerId).addEventListener('click', () => modal.classList.add('show'));
        modal.querySelector(closeBtnClass).addEventListener('click', () => modal.classList.remove('show'));
        modal.addEventListener('click', (e) => { if(e.target === modal) modal.classList.remove('show'); });
    }
    setupModal('ramo-info-modal', null, '.modal-close-button');
    setupModal('custom-confirm-modal', null, '#confirm-reset-no');
    setupModal('tr-nico-message-modal', 'tr-nico-info-btn', '#tr-nico-modal-close-btn');
    setupModal('semester-complete-modal', null, '#semester-complete-modal-close-btn');

    function hideCustomConfirm() { customConfirmModal.classList.remove('show'); }
    function showCustomConfirm(message, onConfirm) {
        customConfirmModal.querySelector('#confirm-message').textContent = message;
        const yesBtn = customConfirmModal.querySelector('#confirm-reset-yes');
        const newYesBtn = yesBtn.cloneNode(true);
        yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
        newYesBtn.addEventListener('click', onConfirm);
        customConfirmModal.classList.add('show');
    }
    
    function showSemesterCompleteModal(message) {
        semesterCompleteModal.querySelector('#semester-complete-message').textContent = message;
        semesterCompleteModal.classList.add('show');
    }
    
    // Filter logic
    const normalize = s => s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    function filterRamos(){
      const q = normalize(busc.value);
      const area = areaF.value;
      ramos.forEach(r=>{
        const txt = normalize(r.textContent);
        const a = r.dataset.area;
        const isVisible = (!q || txt.includes(q)) && (!area || a === area);
        r.style.display = isVisible ? '' : 'none';
        r.classList.toggle('highlight', isVisible && (q !== '' || area !== ''));
      });
    }
    busc.addEventListener('input', filterRamos);
    areaF.addEventListener('change', filterRamos);

    // Local file import/export (for non-logged-in users)
    document.getElementById('export-btn').addEventListener('click', () => {
        const dataToExport = {
            aprobados: [...aprobados],
            theme: themeSelector.value,
            completedSem: [...completedSem],
            completedYear: [...completedYear]
        };
        const dataStr = JSON.stringify(dataToExport);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'progreso_malla_unach_local.json';
        a.click();
        URL.revokeObjectURL(url);
        a.remove();
        showCustomAlert('Progreso local exportado exitosamente.');
    });

    document.getElementById('import-btn').addEventListener('click', () => {
        document.getElementById('import-file').click();
    });

    document.getElementById('import-file').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (data && Array.isArray(data.aprobados)) {
                    aprobados = new Set(data.aprobados);
                    completedSem = new Set(data.completedSem || []);
                    completedYear = new Set(data.completedYear || []);
                    setTheme(data.theme || 'light');
                    saveUserData(); // Save to localStorage
                    updateUI();
                    showCustomAlert('Progreso local importado exitosamente.');
                } else {
                    showCustomAlert('El archivo de progreso no es válido.');
                }
            } catch (error) {
                showCustomAlert('Error al leer el archivo.');
            }
        };
        reader.readAsText(file);
    });
    
    // PDF Export logic
    document.getElementById('export-image-btn').addEventListener('click', async () => {
        showCustomAlert("Generando PDF...");
        // PDF export logic here...
    });
    
    // Calendar logic
    const calendarGrid = document.getElementById('calendar-grid');
    const currentMonthYear = document.getElementById('current-month-year');
    let currentCalendarDate = new Date();

    function renderCalendar() {
        const month = currentCalendarDate.getMonth();
        const year = currentCalendarDate.getFullYear();
        currentMonthYear.textContent = `${new Date(year, month).toLocaleString('es-ES', { month: 'long', year: 'numeric' })}`;
        
        calendarGrid.innerHTML = '';
        const dayNames = ["Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom"];
        dayNames.forEach(day => {
            const dayNameEl = document.createElement('div');
            dayNameEl.className = 'day-name';
            dayNameEl.textContent = day;
            calendarGrid.appendChild(dayNameEl);
        });

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        // Adjust for Monday start
        const startOffset = (firstDay === 0) ? 6 : firstDay - 1;

        for (let i = 0; i < startOffset; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.classList.add('calendar-day', 'empty');
            calendarGrid.appendChild(emptyDay);
        }

        const today = new Date();
        for (let i = 1; i <= daysInMonth; i++) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            dayEl.textContent = i;
            if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                dayEl.classList.add('current-day');
            }
            calendarGrid.appendChild(dayEl);
        }
    }
    document.getElementById('prev-month').addEventListener('click', () => {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
        renderCalendar();
    });
    document.getElementById('next-month').addEventListener('click', () => {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
        renderCalendar();
    });
    renderCalendar();

  </script>
</body>
</html>
